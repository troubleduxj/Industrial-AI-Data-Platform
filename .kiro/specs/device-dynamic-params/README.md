# 设备类型动态参数展示 Spec

## 📋 Spec 概述

本 Spec 定义了设备类型动态参数展示功能的完整实现方案，采用元数据驱动的架构设计。

## 🎯 目标

实现不同设备类型在实时监测页面展示各自特定的监测参数，无需修改前端代码。

## 📁 文件结构

```
.kiro/specs/device-dynamic-params/
├── README.md           # 本文件
├── spec.json           # Spec 元数据配置
├── requirements.md     # 需求文档（6个验收标准）
├── design.md          # 设计文档（6个正确性属性）
└── tasks.md           # 任务列表（15个任务）
```

## 🚀 快速开始

### 1. 查看需求

```bash
# 阅读需求文档，了解功能需求和验收标准
cat .kiro/specs/device-dynamic-params/requirements.md
```

**核心需求**:
- AC-1: 后端提供字段配置查询接口
- AC-2: 后端提供设备实时数据及配置接口
- AC-3: 后端提供批量查询接口
- AC-4: 前端动态渲染监测参数
- AC-5: 前端缓存字段配置
- AC-6: 数据库配置监测字段

### 2. 查看设计

```bash
# 阅读设计文档，了解架构和正确性属性
cat .kiro/specs/device-dynamic-params/design.md
```

**核心设计**:
- 元数据驱动架构
- 6个正确性属性（P-1 到 P-6）
- API 设计
- 组件设计
- 性能优化策略

### 3. 查看任务

```bash
# 阅读任务列表，了解实施步骤
cat .kiro/specs/device-dynamic-params/tasks.md
```

**任务概览**:
- 阶段 1: 后端 API 开发（5个任务，10h）
- 阶段 2: 前端组件开发（5个任务，11h）
- 阶段 3: 数据配置与测试（5个任务，7h）

### 4. 开始实施

使用 Kiro AI 助手逐个完成任务：

```
请帮我实现 TASK-1: 创建设备字段 API 路由
```

## 📊 进度跟踪

### 阶段 1: 后端 API 开发
- [ ] TASK-1: 创建设备字段 API 路由
- [ ] TASK-2: 创建设备字段 Schema
- [ ] TASK-3: 扩展设备实时数据 API
- [ ] TASK-4: 实现批量查询 API
- [ ] TASK-5: 添加数据库索引优化

### 阶段 2: 前端组件开发
- [ ] TASK-6: 创建设备字段 API 接口
- [ ] TASK-7: 扩展设备 API 接口
- [ ] TASK-8: 创建 DynamicMonitoringData 组件
- [ ] TASK-9: 创建设备字段 Store
- [ ] TASK-10: 修改实时监测页面

### 阶段 3: 数据配置与测试
- [ ] TASK-11: 配置焊机监测字段
- [ ] TASK-12: 配置压力传感器监测字段
- [ ] TASK-13: 编写 API 集成测试
- [ ] TASK-14: 编写前端组件测试
- [ ] TASK-15: E2E 测试和文档

## 🔍 验证方法

### 需求验证

每个验收标准（AC）都有明确的验证方法：

```bash
# AC-1: 测试字段配置查询接口
curl http://localhost:8001/api/v2/device-fields/monitoring-keys/WELD_MACHINE

# AC-2: 测试实时数据及配置接口
curl http://localhost:8001/api/v2/devices/WM001/realtime-with-config

# AC-3: 测试批量查询接口
curl -X POST http://localhost:8001/api/v2/devices/batch-realtime-with-config \
  -H "Content-Type: application/json" \
  -d '{"device_codes": ["WM001", "WM002"]}'
```

### 属性验证

每个正确性属性（P）都有对应的测试：

- P-1: 字段配置查询正确性 → 单元测试
- P-2: 字段排序正确性 → 单元测试
- P-3: 实时数据与配置一致性 → 集成测试
- P-4: 批量查询性能优化 → 性能测试
- P-5: 前端数值格式化正确性 → 单元测试
- P-6: 缓存一致性 → 单元测试

## 📚 相关文档

- [设备类型动态参数展示方案](../../../docs/device_test/设备类型动态参数展示方案.md)
- [新增设备类型与AI检测实现指南](../../../docs/device_test/新增设备类型与AI检测实现指南.md)
- [设备模型定义](../../../app/models/device.py)

## 💡 使用建议

### 与 Kiro AI 协作

1. **逐个任务实施**: 按照任务列表顺序，逐个完成任务
2. **验证正确性属性**: 每完成一个任务，验证对应的正确性属性
3. **运行测试**: 确保所有测试通过后再进入下一个任务
4. **更新进度**: 完成任务后更新本 README 的进度跟踪

### 示例对话

```
用户: 请帮我实现 TASK-1: 创建设备字段 API 路由

Kiro: 好的，我将创建设备字段 API 路由。这个任务对应需求 AC-1 和正确性属性 P-1, P-2。

[Kiro 创建文件并实现代码]

Kiro: 已完成 TASK-1，请验证以下内容：
1. API 端点是否正确创建
2. 字段查询逻辑是否正确
3. 排序是否按 sort_order 升序
4. 运行单元测试是否通过

用户: 测试通过，请继续 TASK-2
```

## 🎯 成功标准

本 Spec 完成的标准：

- ✅ 所有 15 个任务完成
- ✅ 所有 6 个验收标准通过
- ✅ 所有 6 个正确性属性验证通过
- ✅ 所有测试通过（单元测试、集成测试、E2E 测试）
- ✅ 代码覆盖率 > 80%
- ✅ 性能要求达标
- ✅ 文档完善

## 🔧 故障排除

### 常见问题

**Q: TDengine 查询性能不达标怎么办？**

A: 
1. 检查 TDengine 索引是否创建
2. 使用连接池优化连接
3. 考虑添加 Redis 缓存
4. 优化查询语句

**Q: 前端缓存不生效怎么办？**

A:
1. 检查 Pinia store 是否正确初始化
2. 检查缓存 key 是否正确
3. 检查浏览器控制台是否有错误
4. 清除浏览器缓存重试

**Q: 字段配置不显示怎么办？**

A:
1. 检查数据库配置是否正确
2. 检查 is_monitoring_key 是否为 true
3. 检查 is_active 是否为 true
4. 检查 API 返回数据是否正确

## 📞 支持

如有问题，请参考：
- [设计文档](./design.md) - 了解架构设计
- [任务列表](./tasks.md) - 查看详细实施步骤
- [方案文档](../../../docs/device_test/设备类型动态参数展示方案.md) - 查看完整方案

---

**Spec 版本**: 1.0.0  
**创建日期**: 2025-11-20  
**状态**: Draft  
**预计完成时间**: 3.5 个工作日
