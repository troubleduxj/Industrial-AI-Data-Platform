# åˆ†é˜¶æ®µæ•°æ®åº“è¿ç§»ç³»ç»Ÿ Makefile

.PHONY: help install test demo start clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "åˆ†é˜¶æ®µæ•°æ®åº“è¿ç§»ç³»ç»Ÿ"
	@echo "====================="
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install    - å®‰è£…ä¾èµ–"
	@echo "  test       - è¿è¡Œç³»ç»Ÿæµ‹è¯•"
	@echo "  demo       - è¿è¡Œæ¼”ç¤º"
	@echo "  start      - å¯åŠ¨è¿ç§»å‘å¯¼"
	@echo "  clean      - æ¸…ç†æ—¥å¿—æ–‡ä»¶"
	@echo "  setup      - åˆå§‹åŒ–ç¯å¢ƒ"
	@echo ""
	@echo "ä½¿ç”¨ç¤ºä¾‹:"
	@echo "  make setup"
	@echo "  make test"
	@echo "  make start"

# å®‰è£…ä¾èµ–
install:
	@echo "å®‰è£…Pythonä¾èµ–..."
	pip install asyncpg aiohttp
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# è®¾ç½®ç¯å¢ƒ
setup: install
	@echo "è®¾ç½®ç¯å¢ƒ..."
	@if [ -z "$$DATABASE_URL" ]; then \
		echo "âš ï¸  è¯·è®¾ç½® DATABASE_URL ç¯å¢ƒå˜é‡"; \
		echo "ä¾‹å¦‚: export DATABASE_URL='postgresql://user:password@localhost:5432/database'"; \
		exit 1; \
	fi
	@echo "âœ… ç¯å¢ƒè®¾ç½®å®Œæˆ"

# è¿è¡Œç³»ç»Ÿæµ‹è¯•
test: setup
	@echo "è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
	python test_migration_system.py

# è¿è¡Œæ¼”ç¤º
demo: setup
	@echo "è¿è¡Œè¿ç§»æ¼”ç¤º..."
	python demo_migration.py

# å¯åŠ¨è¿ç§»å‘å¯¼
start: setup
	@echo "å¯åŠ¨è¿ç§»å‘å¯¼..."
	python start_migration.py

# è¿è¡Œå®Œæ•´è¿ç§»å®æ–½
migrate: setup
	@echo "è¿è¡Œå®Œæ•´è¿ç§»å®æ–½..."
	python implement_phased_migration.py --config config.json

# ä»…å¯åŠ¨ç›‘æ§
monitor: setup
	@echo "å¯åŠ¨ç›‘æ§ç³»ç»Ÿ..."
	python migration_alerting_system.py --db-url "$$DATABASE_URL" --action monitor

# æ£€æŸ¥è¿ç§»çŠ¶æ€
status: setup
	@echo "æ£€æŸ¥è¿ç§»çŠ¶æ€..."
	python phased_migration_strategy.py --db-url "$$DATABASE_URL" --action status

# æ•°æ®ä¸€è‡´æ€§éªŒè¯
validate: setup
	@echo "æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§éªŒè¯..."
	@if [ -z "$$SOURCE_TABLE" ] || [ -z "$$TARGET_TABLE" ]; then \
		echo "è¯·è®¾ç½® SOURCE_TABLE å’Œ TARGET_TABLE ç¯å¢ƒå˜é‡"; \
		echo "ä¾‹å¦‚: make validate SOURCE_TABLE=api TARGET_TABLE=t_sys_api_endpoints"; \
		exit 1; \
	fi
	python data_consistency_validator.py --db-url "$$DATABASE_URL" --source-table "$$SOURCE_TABLE" --target-table "$$TARGET_TABLE" --level detailed

# åˆ‡æ¢åˆ†æ
switch-analytics: setup
	@echo "è·å–åˆ‡æ¢åˆ†æ..."
	@if [ -z "$$CONFIG_ID" ]; then \
		echo "è¯·è®¾ç½® CONFIG_ID ç¯å¢ƒå˜é‡"; \
		echo "ä¾‹å¦‚: make switch-analytics CONFIG_ID=api_gradual_switch"; \
		exit 1; \
	fi
	python configurable_read_switch.py --db-url "$$DATABASE_URL" --action analytics --config-id "$$CONFIG_ID"

# å‘Šè­¦ç»Ÿè®¡
alert-stats: setup
	@echo "è·å–å‘Šè­¦ç»Ÿè®¡..."
	python migration_alerting_system.py --db-url "$$DATABASE_URL" --action statistics --days 7

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
clean:
	@echo "æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
	rm -f *.log
	rm -f migration_*.json
	rm -f validation_*.json
	rm -f alert_*.json
	rm -f final_*.json
	@echo "âœ… æ—¥å¿—æ–‡ä»¶æ¸…ç†å®Œæˆ"

# åˆ›å»ºé…ç½®æ–‡ä»¶
config:
	@echo "åˆ›å»ºé…ç½®æ–‡ä»¶..."
	@if [ ! -f config.json ]; then \
		cp config.json.example config.json; \
		echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º: config.json"; \
		echo "è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶ä»¥é€‚åº”æ‚¨çš„ç¯å¢ƒ"; \
	else \
		echo "âš ï¸  é…ç½®æ–‡ä»¶å·²å­˜åœ¨: config.json"; \
	fi

# å¤‡ä»½é…ç½®
backup-config:
	@echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	cp config.json config_backup_$$timestamp.json 2>/dev/null || true; \
	cp migration_configs.json migration_configs_backup_$$timestamp.json 2>/dev/null || true; \
	cp read_switch_configs.json read_switch_configs_backup_$$timestamp.json 2>/dev/null || true; \
	cp alerting_config.json alerting_config_backup_$$timestamp.json 2>/dev/null || true; \
	echo "âœ… é…ç½®æ–‡ä»¶å¤‡ä»½å®Œæˆ"

# æ¢å¤é…ç½®
restore-config:
	@echo "æ¢å¤é…ç½®æ–‡ä»¶..."
	@if [ -z "$$BACKUP_TIMESTAMP" ]; then \
		echo "è¯·æŒ‡å®šå¤‡ä»½æ—¶é—´æˆ³"; \
		echo "ä¾‹å¦‚: make restore-config BACKUP_TIMESTAMP=20240110_120000"; \
		exit 1; \
	fi
	@cp config_backup_$$BACKUP_TIMESTAMP.json config.json 2>/dev/null || echo "æœªæ‰¾åˆ°ä¸»é…ç½®å¤‡ä»½"; \
	cp migration_configs_backup_$$BACKUP_TIMESTAMP.json migration_configs.json 2>/dev/null || echo "æœªæ‰¾åˆ°è¿ç§»é…ç½®å¤‡ä»½"; \
	cp read_switch_configs_backup_$$BACKUP_TIMESTAMP.json read_switch_configs.json 2>/dev/null || echo "æœªæ‰¾åˆ°åˆ‡æ¢é…ç½®å¤‡ä»½"; \
	cp alerting_config_backup_$$BACKUP_TIMESTAMP.json alerting_config.json 2>/dev/null || echo "æœªæ‰¾åˆ°å‘Šè­¦é…ç½®å¤‡ä»½"; \
	echo "âœ… é…ç½®æ–‡ä»¶æ¢å¤å®Œæˆ"

# ç”Ÿæˆæ–‡æ¡£
docs:
	@echo "ç”Ÿæˆæ–‡æ¡£..."
	@echo "ğŸ“š å¯ç”¨æ–‡æ¡£:"
	@echo "  - QUICK_START_GUIDE.md     å¿«é€Ÿå¼€å§‹æŒ‡å—"
	@echo "  - PHASED_MIGRATION_MANUAL.md  è¯¦ç»†æ“ä½œæ‰‹å†Œ"
	@echo "  - README_MIGRATION_SYSTEM.md  ç³»ç»Ÿè¯´æ˜"

# æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
info:
	@echo "ç³»ç»Ÿä¿¡æ¯"
	@echo "========"
	@echo "Pythonç‰ˆæœ¬: $$(python --version)"
	@echo "å½“å‰ç›®å½•: $$(pwd)"
	@echo "æ•°æ®åº“URL: $${DATABASE_URL:-æœªè®¾ç½®}"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶çŠ¶æ€:"
	@ls -la *.json 2>/dev/null || echo "  æ— é…ç½®æ–‡ä»¶"
	@echo ""
	@echo "æ—¥å¿—æ–‡ä»¶:"
	@ls -la *.log 2>/dev/null || echo "  æ— æ—¥å¿—æ–‡ä»¶"

# å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
e2e-test: setup test demo
	@echo "âœ… ç«¯åˆ°ç«¯æµ‹è¯•å®Œæˆ"

# æ‰§è¡Œå®é™…è¿ç§»
execute: setup
	@echo "æ‰§è¡Œåˆ†é˜¶æ®µæ•°æ®åº“è¿ç§»..."
	python execute_migration.py

# éªŒè¯ç³»ç»Ÿ
verify: setup
	@echo "éªŒè¯ç³»ç»Ÿå‡†å¤‡çŠ¶æ€..."
	python verify_system.py

# ä¸€é”®æ‰§è¡Œè¿ç§»ï¼ˆæœ€ç®€å•ï¼‰
migrate:
	@echo "ä¸€é”®æ‰§è¡Œåˆ†é˜¶æ®µæ•°æ®åº“è¿ç§»..."
	python migrate.py

# è¿è¡Œå®Œæ•´è¿ç§»æµç¨‹ï¼ˆäº¤äº’å¼ï¼‰
migrate-interactive: setup
	@echo "å¯åŠ¨åˆ†é˜¶æ®µè¿ç§»ç³»ç»Ÿ..."
	python run_phased_migration.py

# å¿«é€Ÿå¼€å§‹ï¼ˆæ¨èæ–°ç”¨æˆ·ä½¿ç”¨ï¼‰
quickstart: install config test
	@echo ""
	@echo "ğŸ‰ å¿«é€Ÿå¼€å§‹è®¾ç½®å®Œæˆï¼"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥:"
	@echo "1. è®¾ç½®æ•°æ®åº“è¿æ¥: export DATABASE_URL='postgresql://user:password@localhost:5432/database'"
	@echo "2. ç¼–è¾‘é…ç½®æ–‡ä»¶: vi config.json"
	@echo "3. éªŒè¯ç³»ç»Ÿ: make verify"
	@echo "4. æ‰§è¡Œè¿ç§»: make migrate"

# å¸®åŠ©ä¿¡æ¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
help-detailed:
	@echo "åˆ†é˜¶æ®µæ•°æ®åº“è¿ç§»ç³»ç»Ÿ - è¯¦ç»†å¸®åŠ©"
	@echo "=================================="
	@echo ""
	@echo "ğŸš€ å¿«é€Ÿå¼€å§‹:"
	@echo "  make quickstart    - æ–°ç”¨æˆ·æ¨èï¼Œå®Œæ•´è®¾ç½®"
	@echo "  make setup         - å®‰è£…ä¾èµ–å’Œæ£€æŸ¥ç¯å¢ƒ"
	@echo "  make test          - è¿è¡Œç³»ç»Ÿæµ‹è¯•"
	@echo "  make demo          - è¿è¡ŒåŠŸèƒ½æ¼”ç¤º"
	@echo "  make start         - å¯åŠ¨äº¤äº’å¼è¿ç§»å‘å¯¼"
	@echo ""
	@echo "ğŸ”§ é…ç½®ç®¡ç†:"
	@echo "  make config        - åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶"
	@echo "  make backup-config - å¤‡ä»½å½“å‰é…ç½®"
	@echo "  make restore-config BACKUP_TIMESTAMP=20240110_120000 - æ¢å¤é…ç½®"
	@echo ""
	@echo "ğŸ“Š ç›‘æ§å’Œåˆ†æ:"
	@echo "  make monitor       - å¯åŠ¨ç›‘æ§ç³»ç»Ÿ"
	@echo "  make status        - æ£€æŸ¥è¿ç§»çŠ¶æ€"
	@echo "  make alert-stats   - è·å–å‘Šè­¦ç»Ÿè®¡"
	@echo ""
	@echo "ğŸ” éªŒè¯å’Œåˆ‡æ¢:"
	@echo "  make validate SOURCE_TABLE=api TARGET_TABLE=t_sys_api_endpoints"
	@echo "  make switch-analytics CONFIG_ID=api_gradual_switch"
	@echo ""
	@echo "ğŸ§¹ ç»´æŠ¤:"
	@echo "  make clean         - æ¸…ç†æ—¥å¿—æ–‡ä»¶"
	@echo "  make info          - æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯"
	@echo ""
	@echo "ğŸ“š æ–‡æ¡£:"
	@echo "  make docs          - æŸ¥çœ‹å¯ç”¨æ–‡æ¡£"
	@echo ""
	@echo "ğŸ”— ç¯å¢ƒå˜é‡:"
	@echo "  DATABASE_URL       - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¿…éœ€ï¼‰"
	@echo "  SOURCE_TABLE       - æºè¡¨åï¼ˆéªŒè¯æ—¶ä½¿ç”¨ï¼‰"
	@echo "  TARGET_TABLE       - ç›®æ ‡è¡¨åï¼ˆéªŒè¯æ—¶ä½¿ç”¨ï¼‰"
	@echo "  CONFIG_ID          - åˆ‡æ¢é…ç½®IDï¼ˆåˆ†ææ—¶ä½¿ç”¨ï¼‰"