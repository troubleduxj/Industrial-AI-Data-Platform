# 故障排除

常见问题和解决方案。

## 📚 目录

- [1. 编码问题](#1-编码问题)
- [2. 打包问题](#2-打包问题)
- [3. 版本号问题](#3-版本号问题)
- [4. 部署问题](#4-部署问题)
- [5. 其他问题](#5-其他问题)

---

## 1. 编码问题

### 1.1 问题描述

在运行 `离线打包.bat` 脚本时，可能会看到类似以下的错误信息：

```
'上运行:' is not recognized as an internal or external command,
operable program or batch file.
'启动服务' is not recognized as an internal or external command,
operable program or batch file.
```

### 1.2 问题原因

这是 Windows CMD 批处理文件的**编码问题**，具体原因：

1. **中文冒号问题**
   - 原文: `在目标服务器上运行: 完整部署.bat`
   - CMD 将中文冒号 `:` 后的内容误认为是命令
   - 导致 `上运行:` 被当作命令执行

2. **中文括号问题**
   - 原文: `使用 npm 解压依赖（无需网络）`
   - 中文括号 `（）` 在某些情况下会被错误解析

3. **编码转换问题**
   - 批处理文件使用 UTF-8 编码
   - CMD 默认使用 GBK/CP936 编码
   - 即使使用 `chcp 65001` 切换到 UTF-8，某些特殊字符仍可能出错

### 1.3 解决方案

#### 已修复

✅ **问题已在最新版本中修复！**

修复内容：
- 将所有中文标点改为英文标点
- 修复了 8 处问题位置
- 不影响任何功能

#### 修复对比

**修复前**:
```batch
echo 3. 在目标服务器上运行: 完整部署.bat
echo 4. 使用 npm 解压依赖（无需网络）
```

**修复后**:
```batch
echo 3. 在目标服务器上运行 完整部署.bat
echo 4. 使用 npm 解压依赖 (无需网络)
```

### 1.4 影响范围

#### ✅ 不影响核心功能
- 打包过程正常
- 文件创建正常
- 依赖下载正常
- 构建过程正常

#### ⚠️ 仅影响显示
- 某些提示信息显示异常
- 不影响脚本执行
- 不影响最终结果

### 1.5 最佳实践

#### 避免使用的字符

```
❌ 中文冒号：
❌ 中文括号（）
❌ 中文引号""
❌ 中文逗号，
```

#### 推荐使用的字符

```
✅ 英文冒号 :
✅ 英文括号 ()
✅ 英文引号 ""
✅ 英文逗号 ,
✅ 空格分隔
```

#### 示例对比

**不推荐**:
```batch
echo 步骤1：安装依赖（需要网络）
echo 注意：请确保环境正确
```

**推荐**:
```batch
echo 步骤1 - 安装依赖 (需要网络)
echo 注意 - 请确保环境正确
```

### 1.6 修复记录

**修复日期**: 2025-11-18

**修复文件**:
- `scripts/deployment/离线打包.bat` - 7处修复
- `scripts/deployment/管理打包版本.bat` - 1处修复

**修复详情**:

| 位置 | 修复前 | 修复后 |
|------|--------|--------|
| 行 ~10 | `使用 npm 重新安装前端依赖（替代 pnpm）` | `使用 npm 重新安装前端依赖 (替代 pnpm)` |
| 行 ~110 | `使用 npm 安装依赖（这可能需要几分钟）` | `使用 npm 安装依赖 (这可能需要几分钟)` |
| 行 ~188 | `使用 tar 压缩（保留所有文件）` | `使用 tar 压缩 (保留所有文件)` |
| 行 ~531 | `前端依赖（npm 版本）` | `前端依赖 (npm 版本)` |
| 行 ~536 | `一键部署（推荐）` | `一键部署 (推荐)` |
| 行 ~559 | `压缩包可能较大（几百MB），这是正常的` | `压缩包可能较大 (几百MB), 这是正常的` |
| 行 ~613 | `在目标服务器上运行: 完整部署.bat` | `在目标服务器上运行 完整部署.bat` |
| 行 ~622 | `Node.js（包含 npm），不需要 pnpm` | `Node.js (包含 npm), 不需要 pnpm` |

---

## 2. 打包问题

### 2.1 npm 安装失败

**错误信息**:
```
[错误] npm 安装失败
```

**原因**:
- 网络连接问题
- npm 配置错误
- 依赖冲突

**解决方案**:
```cmd
# 1. 检查网络连接
ping registry.npmjs.org

# 2. 清理 npm 缓存
npm cache clean --force

# 3. 手动安装
cd web
npm install

# 4. 重新打包
cd ..\..
scripts\deployment\离线打包.bat
```

### 2.2 前端构建失败

**错误信息**:
```
[错误] 前端构建失败
```

**原因**:
- Vue 文件语法错误
- 依赖缺失
- 内存不足

**解决方案**:
```cmd
# 1. 检查语法错误
cd web
npm run lint

# 2. 检查依赖
npm install

# 3. 增加内存限制
set NODE_OPTIONS=--max-old-space-size=4096
npm run build

# 4. 重新打包
cd ..
scripts\deployment\离线打包.bat
```

### 2.3 Python 依赖下载失败

**错误信息**:
```
[警告] 部分包下载失败
```

**原因**:
- 网络问题
- PyPI 镜像问题
- 包不存在

**解决方案**:
```cmd
# 1. 检查网络
ping pypi.org

# 2. 切换镜像源
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/

# 3. 手动下载
.venv\Scripts\activate
pip download -r requirements.txt -d offline_packages

# 4. 重新打包
scripts\deployment\离线打包.bat
```

### 2.4 tar 压缩失败

**错误信息**:
```
[警告] tar 压缩失败，尝试使用 PowerShell...
```

**原因**:
- tar 命令不可用
- 文件路径过长
- 权限问题

**解决方案**:
```cmd
# 1. 检查 tar 命令
tar --version

# 2. 使用 PowerShell 压缩（自动回退）
# 脚本会自动尝试 PowerShell

# 3. 手动压缩
cd web_npm_temp
tar -czf ..\web_node_modules.tar.gz node_modules
```

### 2.5 磁盘空间不足

**错误信息**:
```
磁盘空间不足
```

**解决方案**:
```cmd
# 1. 检查磁盘空间
dir

# 2. 清理旧版本
scripts\deployment\管理打包版本.bat
选择 [4] 清理旧版本

# 3. 清理临时文件
rmdir /s /q web_npm_temp
```

---

## 3. 版本号问题

### 3.1 版本号显示为 v1.0.0

**问题**: 打包时版本号总是显示 `v1.0.0`

**原因**: 没有 Git 标签

**解决方案**:
```bash
# 1. 创建标签
git tag -a v1.2.3 -m "Version 1.2.3"

# 2. 推送标签
git push origin v1.2.3

# 3. 重新打包
scripts\deployment\离线打包.bat
```

### 3.2 标签不生效

**问题**: 创建了标签但打包时不使用

**原因**: 
- 标签未推送到本地
- 标签格式不正确
- Git 配置问题

**解决方案**:
```bash
# 1. 检查本地标签
git tag

# 2. 检查标签格式（必须以 v 开头）
git tag -a v1.0.0 -m "Version 1.0.0"

# 3. 确保标签在当前分支
git describe --tags --abbrev=0

# 4. 重新打包
scripts\deployment\离线打包.bat
```

### 3.3 时间戳不正确

**问题**: 时间戳显示错误

**原因**: 系统时间设置错误

**解决方案**:
```cmd
# 1. 检查系统时间
echo %date% %time%

# 2. 修正系统时间
# 在 Windows 设置中调整

# 3. 重新打包
scripts\deployment\离线打包.bat
```

---

## 4. 部署问题

### 4.1 Python 依赖安装失败

**错误信息**:
```
[错误] 依赖安装失败
```

**原因**:
- 虚拟环境未创建
- 依赖包损坏
- Python 版本不匹配

**解决方案**:
```cmd
# 1. 创建虚拟环境
python -m venv .venv

# 2. 激活虚拟环境
.venv\Scripts\activate

# 3. 安装依赖
pip install --no-index --find-links=offline_packages -r requirements.txt

# 4. 检查安装
pip list
```

### 4.2 前端依赖解压失败

**错误信息**:
```
[错误] tar 解压失败
```

**原因**:
- tar 命令不可用
- 压缩包损坏
- 磁盘空间不足

**解决方案**:
```cmd
# 1. 检查压缩包
dir web_node_modules.tar.gz

# 2. 使用 PowerShell 解压
cd web
powershell -Command "tar -xzf ..\web_node_modules.tar.gz"

# 3. 或使用 7-Zip
7z x ..\web_node_modules.tar.gz
7z x web_node_modules.tar
```

### 4.3 服务启动失败

**错误信息**:
```
服务启动失败
```

**原因**:
- 端口被占用
- 配置文件错误
- 数据库连接失败

**解决方案**:
```cmd
# 1. 检查端口占用
netstat -ano | findstr "8000"
netstat -ano | findstr "3000"

# 2. 检查配置文件
notepad .env

# 3. 检查数据库连接
# 确保 PostgreSQL 和 TDengine 正在运行

# 4. 查看日志
type app\logs\*.log
```

---

## 5. 其他问题

### 5.1 releases 目录占用空间过大

**问题**: releases 目录占用几个 GB 空间

**解决方案**:
```cmd
# 1. 查看大小
scripts\deployment\管理打包版本.bat
选择 [6] 计算目录大小

# 2. 清理旧版本
选择 [4] 清理旧版本
输入保留数量: 5

# 3. 压缩归档
选择 [5] 压缩指定版本
# 然后将 ZIP 文件移到外部存储
```

### 5.2 找不到特定版本

**问题**: 无法找到之前打包的版本

**解决方案**:
```cmd
# 1. 列出所有版本
scripts\deployment\管理打包版本.bat
选择 [1] 列出所有版本

# 2. 按版本号搜索
dir releases | findstr "1.0.0"

# 3. 按日期搜索
dir releases | findstr "20251118"

# 4. 查看版本详情
选择 [2] 查看版本详情
输入版本名称
```

### 5.3 误删版本

**问题**: 不小心删除了重要版本

**解决方案**:
```cmd
# 1. 检查回收站
# Windows 回收站可能还有

# 2. 从备份恢复
# 如果有外部备份

# 3. 重新打包
# 如果有对应的 Git 标签
git checkout v1.0.0
scripts\deployment\离线打包.bat
```

### 5.4 版本对比

**问题**: 需要对比两个版本的差异

**解决方案**:
```cmd
# 1. 查看版本信息
fc releases\offline_deploy_1.0.0_xxx\VERSION_INFO.txt ^
   releases\offline_deploy_1.0.1_xxx\VERSION_INFO.txt

# 2. 对比文件大小
dir releases\offline_deploy_1.0.0_xxx
dir releases\offline_deploy_1.0.1_xxx

# 3. 对比关键文件
fc releases\offline_deploy_1.0.0_xxx\requirements.txt ^
   releases\offline_deploy_1.0.1_xxx\requirements.txt
```

### 5.5 权限问题

**问题**: 没有权限创建或删除文件

**解决方案**:
```cmd
# 1. 以管理员身份运行
# 右键 → 以管理员身份运行

# 2. 检查文件夹权限
# 右键文件夹 → 属性 → 安全

# 3. 更改所有者
# 属性 → 安全 → 高级 → 更改所有者
```

---

## 📞 获取帮助

### 检查日志

```cmd
# 部署日志
type deploy_*.log

# 应用日志
type app\logs\*.log

# 构建日志
type web\build.log
```

### 收集信息

在报告问题时，请提供：

1. **错误信息**: 完整的错误输出
2. **环境信息**: 
   - Windows 版本
   - Python 版本
   - Node.js 版本
3. **操作步骤**: 重现问题的步骤
4. **日志文件**: 相关的日志文件

### 联系支持

- 查看项目文档
- 提交 Issue
- 联系开发团队

---

## 📖 相关文档

- [README.md](README.md) - 主文档
- [快速开始.md](快速开始.md) - 快速入门
- [使用指南.md](使用指南.md) - 详细说明

---

**最后更新**: 2025-11-18  
**维护者**: DeviceMonitor 开发团队
