# 离线打包使用指南

完整的离线打包和版本管理使用说明。

## 📚 目录

- [1. 离线打包](#1-离线打包)
- [2. 版本管理](#2-版本管理)
- [3. Git 版本号](#3-git-版本号)
- [4. 最佳实践](#4-最佳实践)

---

## 1. 离线打包

### 1.1 打包流程

#### 运行打包脚本

```cmd
scripts\deployment\离线打包.bat
```

#### 自动完成的步骤

1. **环境检查** - 验证虚拟环境和工具
2. **创建目录** - 生成版本目录 `releases/offline_deploy_{版本}_{时间}`
3. **复制代码** - 后端、前端、共享层、数据库迁移
4. **下载依赖** - Python 依赖包（73个 .whl 文件）
5. **构建前端** - 使用 npm 构建生产版本
6. **打包依赖** - 压缩 node_modules（tar.gz 格式）
7. **创建脚本** - 生成部署和启动脚本
8. **生成说明** - 创建部署说明文档

### 1.2 打包内容

#### 目录结构

```
offline_deploy_{版本}_{时间}/
├── app/                          # 后端代码
├── web/                          # 前端代码
│   ├── src/                     # 源代码
│   ├── dist/                    # 构建产物
│   └── ...
├── packages/                     # 共享代码层
│   └── shared/
├── migrations/                   # 数据库迁移
├── offline_packages/             # Python 依赖（73个包）
├── web_node_modules.tar.gz      # 前端依赖（~162 MB）
├── 完整部署.bat                  # 一键部署脚本
├── 1-安装Python依赖.bat
├── 2-安装前端依赖.bat
├── 启动后端.bat
├── 启动前端.bat
├── 部署说明.txt
├── VERSION_INFO.txt              # 版本信息
├── .env.example
├── requirements.txt
├── README.md
└── run.py
```

#### 文件说明

| 文件/目录 | 大小 | 说明 |
|----------|------|------|
| app/ | ~50 MB | 后端 Python 代码 |
| web/ | ~100 MB | 前端 Vue3 代码和构建产物 |
| packages/ | ~5 MB | 跨端共享代码 |
| offline_packages/ | ~50 MB | Python 依赖包（73个） |
| web_node_modules.tar.gz | ~162 MB | 前端依赖包 |
| **总计** | **~220 MB** | 完整部署包 |

### 1.3 部署脚本

#### 完整部署.bat（推荐）

一键完成所有部署步骤：

```batch
# 功能
1. 安装 Python 依赖（离线）
2. 解压 node_modules（离线）
3. 配置环境变量
4. 生成部署日志
```

#### 分步部署脚本

```batch
1-安装Python依赖.bat    # 单独安装 Python 依赖
2-安装前端依赖.bat      # 单独解压 node_modules
启动后端.bat            # 启动后端服务
启动前端.bat            # 启动前端服务
```

### 1.4 使用场景

#### 场景1：开发环境打包

```cmd
# 1. 开发完成，提交代码
git add .
git commit -m "feat: 新增功能"

# 2. 创建版本标签（可选）
git tag -a v1.1.0 -m "新增功能"

# 3. 运行打包
scripts\deployment\离线打包.bat

# 4. 输出
releases\offline_deploy_1.1.0_20251118_150000\
```

#### 场景2：生产环境部署

```cmd
# 1. 在开发机器上打包
scripts\deployment\离线打包.bat

# 2. 传输到生产服务器
# 使用 U 盘、网络共享等方式

# 3. 在生产服务器上部署
cd offline_deploy_1.1.0_20251118_150000
完整部署.bat

# 4. 启动服务
启动后端.bat
启动前端.bat
```

#### 场景3：测试环境

```cmd
# 打包多个版本进行对比测试
releases/
├── offline_deploy_1.0.0_xxx/  # 稳定版本
├── offline_deploy_1.1.0_xxx/  # 测试版本A
└── offline_deploy_1.1.1_xxx/  # 测试版本B
```

### 1.5 注意事项

#### 环境要求

**目标服务器需要**：
- Python 3.8+
- Node.js 18+ (包含 npm)
- TDengine 3.0+
- PostgreSQL 12+
- Redis 6.0+

**不需要**：
- pnpm（使用 npm 即可）
- 网络连接（完全离线）

#### 磁盘空间

- 每个版本约 220 MB
- 建议预留 2-3 GB 空间
- 定期清理旧版本

#### 兼容性

- 使用 npm 而非 pnpm（更好的兼容性）
- tar.gz 格式（跨平台支持）
- 包含所有必要配置文件

---

## 2. 版本管理

### 2.1 版本命名规则

#### 格式

```
offline_deploy_{版本号}_{时间戳}
```

#### 示例

```
offline_deploy_1.0.0_20251118_143052
offline_deploy_1.2.3_20251118_150230
offline_deploy_2.0.0_20251119_091500
```

#### 组成部分

- **前缀**: `offline_deploy_` (固定)
- **版本号**: 从 Git 标签获取（如 `v1.0.0` → `1.0.0`）
  - 有标签：使用标签版本
  - 无标签：使用默认版本 `1.0.0`
- **时间戳**: `YYYYMMDD_HHMMSS` 格式
  - YYYY: 年份（4位）
  - MM: 月份（2位）
  - DD: 日期（2位）
  - HH: 小时（24小时制）
  - MM: 分钟
  - SS: 秒

### 2.2 版本管理工具

#### 运行工具

```cmd
scripts\deployment\管理打包版本.bat
```

#### 功能菜单

```
[1] 列出所有版本
[2] 查看版本详情
[3] 删除指定版本
[4] 清理旧版本（保留最近N个）
[5] 压缩指定版本
[6] 计算目录大小
[0] 退出
```

#### 功能说明

**[1] 列出所有版本**
- 显示所有打包版本
- 按时间倒序排列
- 显示版本号和时间

**[2] 查看版本详情**
- 显示版本信息文件
- 计算目录大小
- 检查关键文件

**[3] 删除指定版本**
- 输入版本目录名称
- 需要确认（输入 YES）
- 永久删除

**[4] 清理旧版本**
- 保留最近 N 个版本
- 删除其他旧版本
- 需要确认

**[5] 压缩指定版本**
- 创建 ZIP 压缩包
- 节省磁盘空间
- 便于归档

**[6] 计算目录大小**
- 统计所有版本
- 显示总大小
- 帮助规划空间

### 2.3 版本信息文件

每个版本包含 `VERSION_INFO.txt`：

```
打包信息
========================================
版本号: v1.0.0
打包时间: 2025-11-18 14:30:52
时间戳: 20251118_143052
打包目录: offline_deploy_1.0.0_20251118_143052
========================================
```

### 2.4 版本保留策略

#### 开发环境

```cmd
# 保留最近 3-5 个版本
管理打包版本.bat → [4] 清理旧版本 → 输入 5
```

**原因**：
- 快速迭代
- 需要回滚测试
- 磁盘空间有限

#### 生产环境

```cmd
# 保留当前 + 上一个稳定版
管理打包版本.bat → [4] 清理旧版本 → 输入 2
```

**原因**：
- 稳定性优先
- 快速回滚
- 减少风险

#### 测试环境

```cmd
# 保留所有测试版本
# 测试完成后手动删除
管理打包版本.bat → [3] 删除指定版本
```

**原因**：
- 需要对比测试
- 问题追溯
- 测试完成后清理

### 2.5 版本追溯

#### 查找特定版本

```cmd
# 按版本号查找
dir releases | findstr "1.0.0"

# 按日期查找
dir releases | findstr "20251118"

# 按时间范围查找
dir /o-d releases
```

#### 对比版本

```cmd
# 查看版本信息差异
fc releases\offline_deploy_1.0.0_xxx\VERSION_INFO.txt ^
   releases\offline_deploy_1.0.1_xxx\VERSION_INFO.txt
```

---

## 3. Git 版本号

### 3.1 版本号规范

#### 语义化版本

```
v主版本.次版本.修订号[-预发布标识]

示例：
v1.0.0          # 正式版本
v1.2.3          # 正式版本
v2.0.0-beta     # 预发布版本
v2.0.0-rc.1     # 候选版本
```

#### 版本号含义

| 类型 | 说明 | 示例 |
|------|------|------|
| **主版本（Major）** | 重大变更，不兼容的 API 修改 | v1.0.0 → v2.0.0 |
| **次版本（Minor）** | 新增功能，向下兼容 | v1.0.0 → v1.1.0 |
| **修订号（Patch）** | 问题修复，向下兼容 | v1.0.0 → v1.0.1 |

#### 何时升级版本

| 变更类型 | 版本升级 | 示例 |
|---------|---------|------|
| 重大重构、架构变更 | 主版本 | v1.0.0 → v2.0.0 |
| 新增功能、新模块 | 次版本 | v1.0.0 → v1.1.0 |
| Bug 修复、小改进 | 修订号 | v1.0.0 → v1.0.1 |

### 3.2 创建和管理标签

#### 创建第一个版本

```bash
# 1. 确认代码稳定
git status

# 2. 创建初始版本标签
git tag -a v1.0.0 -m "Initial release - 设备监控系统首个正式版本"

# 3. 推送标签
git push origin v1.0.0

# 4. 验证标签
git tag --sort=-v:refname

# 5. 打包测试
scripts\deployment\离线打包.bat
```

#### 后续版本更新

**场景A：修复 Bug（修订号 +1）**

```bash
# 1. 修复 Bug 并提交
git add .
git commit -m "fix: 修复设备数据采集异常"

# 2. 创建修订版本标签
git tag -a v1.0.1 -m "Bug fix: 修复设备数据采集异常"

# 3. 推送
git push origin main
git push origin v1.0.1

# 4. 打包
scripts\deployment\离线打包.bat
# 输出: offline_deploy_1.0.1_20251118_160000
```

**场景B：新增功能（次版本 +1）**

```bash
# 1. 开发新功能并提交
git add .
git commit -m "feat: 新增 AI 异常检测功能"

# 2. 创建次版本标签
git tag -a v1.1.0 -m "Feature: 新增 AI 异常检测功能"

# 3. 推送
git push origin main
git push origin v1.1.0

# 4. 打包
scripts\deployment\离线打包.bat
# 输出: offline_deploy_1.1.0_20251118_160000
```

**场景C：重大更新（主版本 +1）**

```bash
# 1. 完成重大重构并提交
git add .
git commit -m "refactor: 重构数据采集架构"

# 2. 创建主版本标签
git tag -a v2.0.0 -m "Major: 重构数据采集架构，不兼容旧版本"

# 3. 推送
git push origin main
git push origin v2.0.0

# 4. 打包
scripts\deployment\离线打包.bat
# 输出: offline_deploy_2.0.0_20251118_160000
```

#### 预发布版本

```bash
# Beta 版本
git tag -a v1.1.0-beta -m "Beta: 测试新功能"
git push origin v1.1.0-beta

# RC (Release Candidate) 版本
git tag -a v1.1.0-rc.1 -m "RC1: 候选发布版本"
git push origin v1.1.0-rc.1
```

### 3.3 查看和管理标签

#### 查看标签

```bash
# 列出所有标签
git tag

# 按版本号排序
git tag --sort=-v:refname

# 查看最新标签
git describe --tags --abbrev=0

# 查看标签详情
git show v1.0.0
```

#### 删除标签

```bash
# 删除本地标签
git tag -d v1.0.0

# 删除远程标签
git push origin --delete v1.0.0
```

#### 修改标签

```bash
# 1. 删除旧标签
git tag -d v1.0.0
git push origin --delete v1.0.0

# 2. 创建新标签
git tag -a v1.0.0 -m "Updated message"
git push origin v1.0.0
```

### 3.4 版本号与打包名称对照

| Git 标签 | 打包名称示例 | 说明 |
|---------|------------|------|
| 无标签 | `offline_deploy_1.0.0_20251118_150000` | 使用默认版本 |
| v1.0.0 | `offline_deploy_1.0.0_20251118_150000` | 正式版本 |
| v1.2.3 | `offline_deploy_1.2.3_20251118_150000` | 正式版本 |
| v2.0.0-beta | `offline_deploy_2.0.0-beta_20251118_150000` | 预发布版本 |
| v2.0.0-rc.1 | `offline_deploy_2.0.0-rc.1_20251118_150000` | 候选版本 |

### 3.5 版本号工作机制

#### 版本号提取逻辑

```batch
REM 1. 尝试从 Git 获取最新标签
git describe --tags --abbrev=0

REM 2. 如果没有标签，使用默认值
v1.0.0

REM 3. 去除 'v' 前缀
set VERSION_NUM=%VERSION:v=%
```

#### 标签命名规范

✅ **推荐**：
- `v1.0.0`
- `v1.2.3`
- `v2.0.0-beta`

❌ **不推荐**：
- `1.0.0`（缺少 v 前缀）
- `version-1.0.0`（格式不标准）
- `release_1.0.0`（格式不标准）

---

## 4. 最佳实践

### 4.1 版本管理工作流

#### 推荐工作流

```
开发 → 提交 → 创建标签 → 打包 → 部署
```

#### 详细步骤

```bash
# 1. 开发功能
# ...

# 2. 提交代码
git add .
git commit -m "feat: 新增设备健康评分功能"
git push origin main

# 3. 创建版本标签
git tag -a v1.2.0 -m "Release: 新增设备健康评分功能"
git push origin v1.2.0

# 4. 打包部署
scripts\deployment\离线打包.bat
# 生成: offline_deploy_1.2.0_20251118_160000
```

### 4.2 版本策略

#### 开发阶段

```bash
v0.1.0  # 初始开发版本
v0.2.0  # 功能迭代
v0.3.0  # 继续开发
...
v0.9.0  # 接近完成
```

#### 测试阶段

```bash
v1.0.0-alpha    # 内部测试
v1.0.0-beta     # 公开测试
v1.0.0-rc.1     # 候选版本1
v1.0.0-rc.2     # 候选版本2
```

#### 生产阶段

```bash
v1.0.0  # 首个正式版本
v1.0.1  # Bug 修复
v1.1.0  # 新功能
v1.2.0  # 更多功能
v2.0.0  # 重大更新
```

### 4.3 存储管理

#### 定期清理

```cmd
# 每周清理一次
管理打包版本.bat → [4] 清理旧版本 → 保留5个
```

#### 压缩归档

```cmd
# 压缩重要版本
管理打包版本.bat → [5] 压缩指定版本
# 备份到外部存储
```

#### 外部备份

- 重要版本备份到外部存储
- 使用云存储或 NAS
- 定期验证备份完整性

### 4.4 部署建议

#### 开发环境

- 保留 3-5 个版本
- 快速迭代测试
- 及时清理旧版本

#### 测试环境

- 保留所有测试版本
- 测试完成后清理
- 记录测试结果

#### 生产环境

- 保留当前 + 上一个稳定版
- 重要版本长期保留
- 定期备份到外部

### 4.5 常用命令速查

#### Git 标签

```bash
# 创建标签
git tag -a v1.0.0 -m "Release message"

# 推送标签
git push origin v1.0.0

# 查看标签
git tag --sort=-v:refname

# 删除标签
git tag -d v1.0.0
git push origin --delete v1.0.0
```

#### 打包和管理

```cmd
# 创建打包
scripts\deployment\离线打包.bat

# 管理版本
scripts\deployment\管理打包版本.bat

# 查找版本
dir releases | findstr "1.0.0"
```

---

## 📖 相关文档

- [README.md](README.md) - 主文档
- [快速开始.md](快速开始.md) - 快速入门
- [故障排除.md](故障排除.md) - 常见问题

---

**最后更新**: 2025-11-18  
**维护者**: DeviceMonitor 开发团队
