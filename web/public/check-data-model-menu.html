<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ¨¡å‹èœå•è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #409eff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #409eff;
            border-radius: 4px;
        }
        .success { border-left-color: #67c23a; background: #f0f9ff; }
        .warning { border-left-color: #e6a23c; background: #fdf6ec; }
        .error { border-left-color: #f56c6c; background: #fef0f0; }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #66b1ff; }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
        }
        .status { 
            display: inline-block; 
            padding: 3px 10px; 
            border-radius: 3px; 
            font-size: 12px;
            font-weight: bold;
        }
        .status.ok { background: #67c23a; color: white; }
        .status.fail { background: #f56c6c; color: white; }
        .status.warn { background: #e6a23c; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #409eff;
            color: white;
        }
        tr:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ•°æ®æ¨¡å‹ç®¡ç†èœå•è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“‹ è¯Šæ–­è¯´æ˜</h3>
            <p>æœ¬å·¥å…·å°†æ£€æŸ¥"æ•°æ®æ¨¡å‹ç®¡ç†"èœå•çš„è·¯ç”±ã€æƒé™å’Œé…ç½®çŠ¶æ€ã€‚</p>
            <p><strong>ä½¿ç”¨å‰æ</strong>ï¼šè¯·ç¡®ä¿å·²ç™»å½•ç³»ç»Ÿ</p>
        </div>

        <div class="section">
            <h3>ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
            <button onclick="checkRoutes()">æ£€æŸ¥è·¯ç”±</button>
            <button onclick="checkMenus()">æ£€æŸ¥èœå•</button>
            <button onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
            <button onclick="runAllChecks()">è¿è¡Œæ‰€æœ‰æ£€æŸ¥</button>
            <button onclick="refreshRoutes()">åˆ·æ–°è·¯ç”±</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        function addResult(title, content, type = 'section') {
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(div);
        }

        function checkRoutes() {
            clearResults();
            try {
                // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„ä½ç½®è·å–router
                const router = window.$router || 
                               window.__VUE_APP__?.config?.globalProperties?.$router ||
                               window.__VUE_ROUTER__;

                if (!router) {
                    addResult('âŒ è·¯ç”±æ£€æŸ¥å¤±è´¥', '<p>æ— æ³•è®¿é—®è·¯ç”±å™¨å®ä¾‹ã€‚è¯·ç¡®ä¿ï¼š</p><ol><li>å·²ç™»å½•ç³»ç»Ÿ</li><li>åœ¨ç³»ç»Ÿå†…æ‰“å¼€æ­¤é¡µé¢ï¼ˆä¸æ˜¯ç‹¬ç«‹æ‰“å¼€ï¼‰</li></ol>', 'error');
                    return;
                }

                const allRoutes = router.getRoutes();
                const dataModelRoutes = allRoutes.filter(r => 
                    r.path && (r.path.includes('data-model') || r.name?.includes('DataModel'))
                );

                let html = '<table><tr><th>åç§°</th><th>è·¯å¾„</th><th>ç»„ä»¶</th></tr>';
                
                if (dataModelRoutes.length === 0) {
                    addResult('âš ï¸ è·¯ç”±æ£€æŸ¥', '<p class="status warn">æœªæ‰¾åˆ°æ•°æ®æ¨¡å‹ç›¸å…³è·¯ç”±</p><p>è·¯ç”±æ–‡ä»¶å¯èƒ½æœªè¢«æ­£ç¡®åŠ è½½ã€‚</p>', 'warning');
                } else {
                    dataModelRoutes.forEach(route => {
                        html += `<tr>
                            <td>${route.name || '(æ— åç§°)'}</td>
                            <td><code>${route.path}</code></td>
                            <td>${route.component ? 'âœ…' : 'âŒ'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    html += `<p>âœ… æ‰¾åˆ° <strong>${dataModelRoutes.length}</strong> ä¸ªç›¸å…³è·¯ç”±</p>`;
                    addResult('âœ… è·¯ç”±æ£€æŸ¥', html, 'success');
                }

                // æ˜¾ç¤ºæ‰€æœ‰è·¯ç”±æ‘˜è¦
                const summary = `<p>æ€»è·¯ç”±æ•°: <strong>${allRoutes.length}</strong></p>`;
                addResult('ğŸ“Š è·¯ç”±æ‘˜è¦', summary, 'section');

            } catch (error) {
                addResult('âŒ è·¯ç”±æ£€æŸ¥é”™è¯¯', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        function checkMenus() {
            try {
                // å°è¯•ä»piniaè·å–ç”¨æˆ·store
                const pinia = window.$pinia;
                if (!pinia) {
                    addResult('âŒ èœå•æ£€æŸ¥å¤±è´¥', '<p>æ— æ³•è®¿é—®çŠ¶æ€ç®¡ç†ï¼ˆPiniaï¼‰ã€‚è¯·åœ¨ç³»ç»Ÿå†…æ‰“å¼€æ­¤é¡µé¢ã€‚</p>', 'error');
                    return;
                }

                const userStore = pinia._s.get('user');
                if (!userStore) {
                    addResult('âŒ èœå•æ£€æŸ¥å¤±è´¥', '<p>æœªæ‰¾åˆ°ç”¨æˆ·Storeã€‚è¯·ç¡®ä¿å·²ç™»å½•ã€‚</p>', 'error');
                    return;
                }

                const menus = userStore.menus || [];
                const dataModelMenu = menus.find(m => 
                    m.path === '/data-model' || 
                    m.name?.includes('æ•°æ®æ¨¡å‹')
                );

                if (!dataModelMenu) {
                    addResult('âš ï¸ èœå•æ£€æŸ¥', 
                        '<p class="status warn">æœªæ‰¾åˆ°"æ•°æ®æ¨¡å‹ç®¡ç†"èœå•</p>' +
                        '<h4>å¯èƒ½åŸå› ï¼š</h4>' +
                        '<ol>' +
                        '<li>èœå•æœªåœ¨æ•°æ®åº“ä¸­åˆ›å»º</li>' +
                        '<li>è·¯å¾„é…ç½®ä¸æ­£ç¡®ï¼ˆåº”ä¸º <code>/data-model</code>ï¼‰</li>' +
                        '<li>æƒé™æœªåˆ†é…ç»™å½“å‰è§’è‰²</li>' +
                        '<li>èœå•è¢«éšè—ï¼ˆis_visible=falseï¼‰</li>' +
                        '</ol>' +
                        '<h4>è§£å†³æ–¹æ¡ˆï¼š</h4>' +
                        '<p>è¿è¡Œæ•°æ®åº“è„šæœ¬ï¼š<code>python database/migrations/device-data-model/execute_menu_migration.py</code></p>',
                        'warning');
                } else {
                    let html = '<table><tr><th>å±æ€§</th><th>å€¼</th></tr>';
                    html += `<tr><td>åç§°</td><td>${dataModelMenu.name || dataModelMenu.title}</td></tr>`;
                    html += `<tr><td>è·¯å¾„</td><td><code>${dataModelMenu.path}</code></td></tr>`;
                    html += `<tr><td>å›¾æ ‡</td><td>${dataModelMenu.icon || '(æ— )'}</td></tr>`;
                    html += `<tr><td>æ˜¯å¦å¯è§</td><td>${dataModelMenu.is_visible !== false ? 'âœ…' : 'âŒ'}</td></tr>`;
                    html += `<tr><td>å­èœå•æ•°</td><td>${dataModelMenu.children?.length || 0}</td></tr>`;
                    html += '</table>';

                    if (dataModelMenu.children && dataModelMenu.children.length > 0) {
                        html += '<h4>å­èœå•ï¼š</h4><ul>';
                        dataModelMenu.children.forEach(child => {
                            html += `<li>${child.name || child.title} - <code>${child.path}</code></li>`;
                        });
                        html += '</ul>';
                    }

                    addResult('âœ… èœå•æ£€æŸ¥', html, 'success');
                }

                // æ˜¾ç¤ºæ‰€æœ‰èœå•
                let allMenusHtml = `<p>ç”¨æˆ·èœå•æ€»æ•°: <strong>${menus.length}</strong></p>`;
                allMenusHtml += '<details><summary>æŸ¥çœ‹æ‰€æœ‰èœå•</summary><pre>' + 
                                JSON.stringify(menus, null, 2) + '</pre></details>';
                addResult('ğŸ“Š æ‰€æœ‰èœå•', allMenusHtml, 'section');

            } catch (error) {
                addResult('âŒ èœå•æ£€æŸ¥é”™è¯¯', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        function checkPermissions() {
            try {
                const pinia = window.$pinia;
                if (!pinia) {
                    addResult('âŒ æƒé™æ£€æŸ¥å¤±è´¥', '<p>æ— æ³•è®¿é—®çŠ¶æ€ç®¡ç†ã€‚</p>', 'error');
                    return;
                }

                const permissionStore = pinia._s.get('permission');
                if (!permissionStore) {
                    addResult('âš ï¸ æƒé™æ£€æŸ¥', '<p>æœªæ‰¾åˆ°æƒé™Storeã€‚</p>', 'warning');
                    return;
                }

                const accessRoutes = permissionStore.accessRoutes || [];
                const dataModelRoute = accessRoutes.find(r => r.path === '/data-model');

                let html = '<table><tr><th>å±æ€§</th><th>å€¼</th></tr>';
                html += `<tr><td>æƒé™è·¯ç”±æ€»æ•°</td><td>${accessRoutes.length}</td></tr>`;
                html += `<tr><td>æ•°æ®æ¨¡å‹è·¯ç”±</td><td>${dataModelRoute ? 'âœ… å·²æˆæƒ' : 'âŒ æœªæˆæƒ'}</td></tr>`;
                html += '</table>';

                if (dataModelRoute) {
                    html += '<h4>æ•°æ®æ¨¡å‹è·¯ç”±è¯¦æƒ…ï¼š</h4><pre>' + 
                            JSON.stringify(dataModelRoute, null, 2) + '</pre>';
                    addResult('âœ… æƒé™æ£€æŸ¥', html, 'success');
                } else {
                    html += '<p class="status warn">å½“å‰ç”¨æˆ·æ— æ•°æ®æ¨¡å‹ç®¡ç†æƒé™</p>';
                    html += '<p>è¯·åœ¨"ç³»ç»Ÿç®¡ç† â†’ è§’è‰²ç®¡ç†"ä¸­ä¸ºæ‚¨çš„è§’è‰²åˆ†é…æƒé™ã€‚</p>';
                    addResult('âš ï¸ æƒé™æ£€æŸ¥', html, 'warning');
                }

            } catch (error) {
                addResult('âŒ æƒé™æ£€æŸ¥é”™è¯¯', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        async function refreshRoutes() {
            try {
                const pinia = window.$pinia;
                if (!pinia) {
                    addResult('âŒ åˆ·æ–°å¤±è´¥', '<p>æ— æ³•è®¿é—®çŠ¶æ€ç®¡ç†ã€‚</p>', 'error');
                    return;
                }

                const permissionStore = pinia._s.get('permission');
                if (!permissionStore || !permissionStore.generateRoutes) {
                    addResult('âŒ åˆ·æ–°å¤±è´¥', '<p>æƒé™Storeæ–¹æ³•ä¸å¯ç”¨ã€‚</p>', 'error');
                    return;
                }

                addResult('ğŸ”„ æ­£åœ¨åˆ·æ–°è·¯ç”±...', '<p>è¯·ç¨å€™...</p>', 'section');
                
                await permissionStore.generateRoutes();
                
                addResult('âœ… è·¯ç”±åˆ·æ–°æˆåŠŸ', '<p>è·¯ç”±å·²é‡æ–°ç”Ÿæˆã€‚è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœã€‚</p>', 'success');
                
                setTimeout(() => {
                    runAllChecks();
                }, 1000);

            } catch (error) {
                addResult('âŒ åˆ·æ–°è·¯ç”±é”™è¯¯', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        function runAllChecks() {
            clearResults();
            addResult('ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­...', '<p>æ­£åœ¨æ£€æŸ¥æ‰€æœ‰é¡¹...</p>', 'section');
            setTimeout(() => {
                checkRoutes();
                checkMenus();
                checkPermissions();
            }, 100);
        }

        // é¡µé¢åŠ è½½æ—¶æç¤º
        window.addEventListener('load', () => {
            addResult('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨è¯Šæ–­å·¥å…·', 
                '<p>è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è¯Šæ–­ã€‚</p>' +
                '<p><strong>å»ºè®®</strong>ï¼šå…ˆç‚¹å‡»"è¿è¡Œæ‰€æœ‰æ£€æŸ¥"è·å–å®Œæ•´æŠ¥å‘Šã€‚</p>',
                'section');
        });
    </script>
</body>
</html>

