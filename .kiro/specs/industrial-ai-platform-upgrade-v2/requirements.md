# 需求文档 - 工业AI数据平台升级 V2

## 项目介绍

本规范定义了工业AI数据平台第二阶段升级的需求。基于V1升级的基础，本阶段专注于补齐与原始设计规划的偏差，实现完整的AI闭环、实时数据推送、模型文件管理和决策引擎等核心功能。

## 术语表

- **决策引擎（Decision_Engine）**: 将AI预测结果转化为告警和动作的规则运行时系统
- **模型仓库（Model_Repository）**: 存储和管理AI模型文件的系统（MinIO/本地存储）
- **数据采集层（Ingestion_Layer）**: 统一的数据接入和采集模块
- **实时推送服务（Realtime_Push_Service）**: 基于WebSocket的实时数据推送系统
- **预测存储（Prediction_Store）**: 存储预测结果的TDengine时序表
- **特征存储（Feature_Store）**: 存储计算后特征的TDengine时序表
- **平台（Platform）**: 工业AI数据平台系统

## 需求

### 需求1：决策引擎实现

**用户故事：** 作为运维工程师，我希望系统能够根据AI预测结果自动触发告警和动作，以便实现预测性维护的完整闭环。

#### 验收标准

1. 当AI模型产生预测结果时，决策引擎应评估预配置的规则条件
2. 当预测值超过阈值时，决策引擎应自动生成相应级别的告警
3. 当规则条件满足时，决策引擎应支持触发预定义的动作（通知、工单等）
4. 决策引擎应支持基于DSL的规则定义，包括条件表达式和动作配置
5. 当规则被触发时，决策引擎应记录完整的决策日志以供审计
6. 决策引擎应支持规则的启用、禁用和优先级配置

### 需求2：模型文件存储管理

**用户故事：** 作为数据科学家，我希望能够上传、存储和管理AI模型文件，以便模型能够被实际加载和执行推理。

#### 验收标准

1. 当上传模型文件时，平台应将文件存储到配置的存储后端（MinIO或本地）
2. 当存储模型文件时，平台应支持.pkl、.onnx、.h5和.joblib格式
3. 当创建模型版本时，平台应关联模型文件路径和校验和
4. 当激活模型版本时，推理服务应从存储后端加载实际模型文件
5. 当删除模型版本时，平台应清理关联的模型文件
6. 平台应支持模型文件的版本回溯和下载

### 需求3：实时数据WebSocket推送

**用户故事：** 作为运营经理，我希望监控仪表板能够实时更新资产数据，以便无需手动刷新即可看到最新状态。

#### 验收标准

1. 当客户端连接WebSocket时，平台应建立持久连接并进行身份验证
2. 当资产数据更新时，平台应在1秒内将数据推送到订阅的客户端
3. 当客户端订阅特定资产时，平台应只推送该资产的相关数据
4. 当连接断开时，平台应支持自动重连和状态恢复
5. 平台应支持批量订阅多个资产的实时数据
6. 当推送数据时，平台应包含时间戳和数据质量标识

### 需求4：预测结果时序存储

**用户故事：** 作为数据分析师，我希望能够查询历史预测结果的时序数据，以便分析预测准确性和趋势。

#### 验收标准

1. 当AI模型产生预测结果时，平台应同时写入PostgreSQL和TDengine
2. 当存储预测结果时，TDengine应使用pred_{category}超级表结构
3. 当查询预测历史时，平台应支持按时间范围、资产和模型筛选
4. 当聚合预测数据时，平台应支持计算准确率、偏差等统计指标
5. 平台应支持预测结果与实际值的对比分析查询

### 需求5：数据采集层统一

**用户故事：** 作为系统集成工程师，我希望有统一的数据采集接口，以便规范化接入不同类型的数据源。

#### 验收标准

1. 当配置数据源时，平台应支持MQTT、HTTP、Modbus等协议适配器
2. 当接收数据时，采集层应进行数据验证和格式转换
3. 当数据写入时，采集层应支持双写模式（新旧架构同时写入）
4. 当数据源异常时，采集层应记录错误并支持重试机制
5. 采集层应提供数据采集状态监控和统计接口
6. 当添加新数据源类型时，平台应支持通过配置扩展适配器

### 需求6：特征存储完善

**用户故事：** 作为AI工程师，我希望特征计算结果能够自动存储到专用表中，以便特征可以被复用和追溯。

#### 验收标准

1. 当激活特征视图时，平台应自动创建feat_{category}超级表
2. 当流计算产生特征时，平台应将结果写入对应的特征表
3. 当查询特征数据时，平台应支持按资产、时间范围和特征名筛选
4. 当特征定义变更时，平台应支持特征表的Schema演进
5. 平台应提供特征血缘追踪，记录特征的来源信号和计算逻辑

### 需求7：前端实时监控增强

**用户故事：** 作为最终用户，我希望监控页面能够实时显示资产状态和预测结果，以便及时发现潜在问题。

#### 验收标准

1. 当打开监控页面时，前端应自动建立WebSocket连接
2. 当收到实时数据时，前端应更新图表和数值显示而无需刷新页面
3. 当预测结果产生时，前端应在监控面板中显示预测值和置信度
4. 当告警触发时，前端应实时显示告警通知
5. 前端应支持配置数据刷新频率和显示精度
6. 当网络断开时，前端应显示连接状态并自动重连

### 需求8：双写模式集成

**用户故事：** 作为系统管理员，我希望在迁移期间数据能够同时写入新旧系统，以便确保数据一致性和平滑过渡。

#### 验收标准

1. 当启用双写模式时，平台应将数据同时写入新旧数据结构
2. 当双写发生错误时，平台应记录错误但不影响主写入流程
3. 当验证数据一致性时，平台应提供新旧数据对比报告
4. 当完成迁移验证时，平台应支持关闭双写模式
5. 双写模式应支持按资产类别粒度启用或禁用

### 需求9：目录结构重构

**用户故事：** 作为开发者，我希望代码按照平台职责组织，以便更好地理解和维护系统架构。

#### 验收标准

1. 平台应将AI相关代码迁移到独立的ai_engine目录
2. 平台应将元数据管理代码组织到platform/metadata目录
3. 平台应将时序数据处理代码组织到platform/timeseries目录
4. 平台应将数据采集代码组织到platform/ingestion目录
5. 重构后的代码应保持API兼容性，不影响现有功能
6. 平台应提供清晰的模块依赖关系和接口定义

### 需求10：企业身份集成

**用户故事：** 作为企业IT管理员，我希望平台能够与企业身份系统集成，以便统一管理用户认证。

#### 验收标准

1. 当配置LDAP时，平台应支持通过LDAP服务器验证用户凭据
2. 当配置OAuth2时，平台应支持第三方身份提供商登录
3. 当用户首次登录时，平台应自动创建本地用户记录
4. 当用户权限变更时，平台应支持从身份系统同步角色
5. 平台应支持多种身份提供商的并行配置
