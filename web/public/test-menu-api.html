<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•èœå•API - æ•°æ®æ¨¡å‹ç®¡ç†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; border-bottom: 3px solid #409eff; padding-bottom: 10px; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #409eff; border-radius: 4px; }
        .success { border-left-color: #67c23a; background: #f0f9ff; }
        .warning { border-left-color: #e6a23c; background: #fdf6ec; }
        .error { border-left-color: #f56c6c; background: #fef0f0; }
        button { background: #409eff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #66b1ff; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; }
        .status { display: inline-block; padding: 3px 10px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .status.ok { background: #67c23a; color: white; }
        .status.fail { background: #f56c6c; color: white; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” èœå•APIæµ‹è¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>1. æ£€æŸ¥Token</h3>
            <button onclick="checkToken()">æ£€æŸ¥Token</button>
            <div id="tokenResult"></div>
        </div>

        <div class="section">
            <h3>2. è°ƒç”¨èœå•API</h3>
            <button onclick="testMenuAPI()">æµ‹è¯• /api/v2/user/menus</button>
            <button onclick="testMenuAPIv1()">æµ‹è¯• /api/v2/usermenu</button>
            <button onclick="testMenuAPIold()">æµ‹è¯• /api/v1/base/usermenu</button>
            <div id="apiResult"></div>
        </div>

        <div class="section">
            <h3>3. æ£€æŸ¥å‰ç«¯Store</h3>
            <button onclick="checkStore()">æ£€æŸ¥Pinia Store</button>
            <div id="storeResult"></div>
        </div>

        <div class="section">
            <h3>4. æ¸…é™¤ç¼“å­˜</h3>
            <button onclick="clearCache()">æ¸…é™¤LocalStorage</button>
            <button onclick="clearAll()">æ¸…é™¤æ‰€æœ‰å¹¶åˆ·æ–°</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function addResult(title, content, type = 'section') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `section ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            results.appendChild(div);
        }

        function checkToken() {
            const resultDiv = document.getElementById('tokenResult');
            const token = localStorage.getItem('token');
            
            if (token) {
                resultDiv.innerHTML = `
                    <p class="status ok">Tokenå­˜åœ¨</p>
                    <pre>${token.substring(0, 50)}...</pre>
                `;
            } else {
                resultDiv.innerHTML = `
                    <p class="status fail">Tokenä¸å­˜åœ¨</p>
                    <p>è¯·å…ˆç™»å½•ç³»ç»Ÿ</p>
                `;
            }
        }

        async function testMenuAPI() {
            const resultDiv = document.getElementById('apiResult');
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.innerHTML = '<p class="status fail">è¯·å…ˆç™»å½•</p>';
                return;
            }

            try {
                resultDiv.innerHTML = '<p>æ­£åœ¨è°ƒç”¨API...</p>';
                
                const response = await fetch('/api/v2/user/menus', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                // æŸ¥æ‰¾æ•°æ®æ¨¡å‹èœå•
                const findMenu = (menus, path) => {
                    if (!menus) return null;
                    for (let menu of menus) {
                        if (menu.path === path || menu.path?.includes(path)) {
                            return menu;
                        }
                        if (menu.children) {
                            const found = findMenu(menu.children, path);
                            if (found) return found;
                        }
                    }
                    return null;
                };
                
                const dataModelMenu = findMenu(data.data || [], '/data-model');
                
                let html = '<h4>APIå“åº”:</h4>';
                html += `<p>çŠ¶æ€ç : ${response.status}</p>`;
                html += `<p>èœå•æ€»æ•°: ${data.data?.length || 0}</p>`;
                
                if (dataModelMenu) {
                    html += '<p class="status ok">âœ… æ‰¾åˆ°æ•°æ®æ¨¡å‹èœå•</p>';
                    html += '<pre>' + JSON.stringify(dataModelMenu, null, 2) + '</pre>';
                } else {
                    html += '<p class="status fail">âŒ æœªæ‰¾åˆ°æ•°æ®æ¨¡å‹èœå•</p>';
                    html += '<h4>æ‰€æœ‰èœå•è·¯å¾„:</h4><ul>';
                    
                    const listPaths = (menus) => {
                        let paths = [];
                        menus?.forEach(m => {
                            paths.push(m.path);
                            if (m.children) {
                                paths = paths.concat(listPaths(m.children));
                            }
                        });
                        return paths;
                    };
                    
                    listPaths(data.data).forEach(path => {
                        html += `<li>${path}</li>`;
                    });
                    html += '</ul>';
                }
                
                html += '<h4>å®Œæ•´å“åº”:</h4>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="status fail">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function testMenuAPIv1() {
            const resultDiv = document.getElementById('apiResult');
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.innerHTML = '<p class="status fail">è¯·å…ˆç™»å½•</p>';
                return;
            }

            try {
                resultDiv.innerHTML = '<p>æ­£åœ¨è°ƒç”¨API (v2/usermenu)...</p>';
                
                const response = await fetch('/api/v2/usermenu', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                let html = '<h4>APIå“åº” (v2/usermenu):</h4>';
                html += `<p>çŠ¶æ€ç : ${response.status}</p>`;
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="status fail">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }

        async function testMenuAPIold() {
            const resultDiv = document.getElementById('apiResult');
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.innerHTML = '<p class="status fail">è¯·å…ˆç™»å½•</p>';
                return;
            }

            try {
                resultDiv.innerHTML = '<p>æ­£åœ¨è°ƒç”¨API (v1)...</p>';
                
                const response = await fetch('/api/v1/base/usermenu', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                let html = '<h4>APIå“åº” (v1):</h4>';
                html += `<p>çŠ¶æ€ç : ${response.status}</p>`;
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="status fail">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }

        function checkStore() {
            const resultDiv = document.getElementById('storeResult');
            
            try {
                if (!window.$pinia) {
                    resultDiv.innerHTML = '<p class="status fail">Piniaæœªåˆå§‹åŒ–ï¼ˆè¯·åœ¨ç³»ç»Ÿå†…æ‰“å¼€æ­¤é¡µé¢ï¼‰</p>';
                    return;
                }
                
                const userStore = window.$pinia._s.get('user');
                const permissionStore = window.$pinia._s.get('permission');
                
                let html = '<h4>User Store:</h4>';
                if (userStore) {
                    html += `<p>ç”¨æˆ·: ${userStore.username || '(ç©º)'}</p>`;
                    html += `<p>èœå•æ•°é‡: ${userStore.menus?.length || 0}</p>`;
                    
                    const dataModelMenu = userStore.menus?.find(m => m.path === '/data-model');
                    if (dataModelMenu) {
                        html += '<p class="status ok">âœ… Storeä¸­æœ‰æ•°æ®æ¨¡å‹èœå•</p>';
                        html += '<pre>' + JSON.stringify(dataModelMenu, null, 2) + '</pre>';
                    } else {
                        html += '<p class="status fail">âŒ Storeä¸­æ²¡æœ‰æ•°æ®æ¨¡å‹èœå•</p>';
                    }
                } else {
                    html += '<p class="status fail">User Storeæœªæ‰¾åˆ°</p>';
                }
                
                html += '<h4>Permission Store:</h4>';
                if (permissionStore) {
                    html += `<p>æƒé™è·¯ç”±æ•°é‡: ${permissionStore.accessRoutes?.length || 0}</p>`;
                } else {
                    html += '<p class="status fail">Permission Storeæœªæ‰¾åˆ°</p>';
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="status fail">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        }

        function clearCache() {
            localStorage.clear();
            alert('LocalStorageå·²æ¸…é™¤ï¼è¯·é‡æ–°ç™»å½•ã€‚');
        }

        function clearAll() {
            localStorage.clear();
            sessionStorage.clear();
            alert('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤ï¼é¡µé¢å°†åˆ·æ–°ã€‚');
            window.location.reload();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            checkToken();
        });
    </script>
</body>
</html>

