# 设备字段配置管理 - 权限修复说明

## 问题描述
超级管理员登录后，在设备字段配置管理页面中，新增、编辑、删除按钮没有权限显示。

## 原因分析
1. 前端页面缺少权限控制指令（`v-permission`）
2. 数据库中可能缺少相关的 API 权限配置
3. 管理员角色可能未分配相关权限

## 解决方案

### 方案一：使用 Python 脚本（推荐）

```bash
# 在项目根目录执行
python database/migrations/device-field-config-ui/fix_permissions.py
```

### 方案二：直接执行 SQL

```bash
# 使用 psql 命令行工具
psql -U postgres -d devicemonitor -f database/migrations/device-field-config-ui/fix_admin_permissions.sql
```

### 方案三：手动验证和修复

1. **验证当前权限配置**
```bash
psql -U postgres -d devicemonitor -f database/migrations/device-field-config-ui/verify_permissions.sql
```

2. **如果发现缺失，执行修复脚本**
```bash
psql -U postgres -d devicemonitor -f database/migrations/device-field-config-ui/fix_admin_permissions.sql
```

## 修复内容

### 1. 前端代码修复
- ✅ 新增按钮添加权限控制：`v-permission="'POST /api/v2/device-fields'"`
- ✅ 编辑按钮添加权限检查：`hasPermission('PUT /api/v2/device-fields/{field_id}')`
- ✅ 删除按钮添加权限检查：`hasPermission('DELETE /api/v2/device-fields/{field_id}')`

### 2. 数据库权限配置
确保以下 API 权限存在并分配给管理员角色：

| API 路径 | 方法 | 说明 |
|---------|------|------|
| `/api/v2/device-fields/monitoring-keys/{device_type_code}` | GET | 获取监测关键字段 |
| `/api/v2/device-fields` | POST | 创建设备字段 |
| `/api/v2/device-fields/{field_id}` | PUT | 更新设备字段 |
| `/api/v2/device-fields/{field_id}` | DELETE | 删除设备字段 |
| `/api/v2/device-fields/cache/clear` | POST | 清除字段缓存 |

### 3. 菜单权限配置
确保"设备字段配置"菜单已添加到系统管理下，并分配给管理员角色。

## 验证步骤

1. **执行修复脚本后，重新登录系统**
   - 清除浏览器缓存或使用无痕模式
   - 使用 admin 账号重新登录

2. **访问设备字段配置页面**
   - 导航到：系统管理 -> 设备字段配置

3. **验证按钮权限**
   - ✅ "新增字段" 按钮应该可见
   - ✅ 表格中的"编辑"按钮应该可见
   - ✅ 表格中的"删除"按钮应该可见

4. **测试功能**
   - 选择一个设备类型
   - 点击"新增字段"按钮，应该能打开表单
   - 点击"编辑"按钮，应该能编辑字段
   - 点击"删除"按钮，应该能删除字段

## 常见问题

### Q1: 执行脚本后仍然没有权限？
**A:** 请确保：
1. 重新登录系统（清除旧的 token）
2. 检查浏览器控制台是否有错误
3. 验证数据库中权限是否正确配置

### Q2: 如何检查当前用户的权限？
**A:** 在浏览器控制台执行：
```javascript
console.log(window.$permission)
```

### Q3: 按钮显示但点击无效？
**A:** 检查：
1. 后端 API 是否正常运行
2. 网络请求是否成功（F12 查看 Network）
3. 后端日志是否有错误信息

## 相关文件

- 前端页面：`web/src/views/system/device-field/index.vue`
- 后端 API：`app/api/v2/device_field_config.py`
- 权限配置：`database/migrations/device-field-config-ui/setup.sql`
- 修复脚本：`database/migrations/device-field-config-ui/fix_admin_permissions.sql`
- Python 脚本：`database/migrations/device-field-config-ui/fix_permissions.py`
