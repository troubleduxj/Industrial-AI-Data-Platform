xu# 实施计划：工业AI数据平台升级 V2

## 概述

本实施计划将V2升级设计分解为可执行的开发任务，按照依赖关系和优先级组织。每个任务都关联到具体的需求和设计属性。

## 任务列表

- [x] 1. 决策引擎核心实现
  - [x] 1.1 实现规则DSL解析器
    - 创建 `ai_engine/decision_engine/rule_parser.py`
    - 实现 `RuleParser.parse()` 方法解析JSON DSL
    - 实现 `RuleParser.validate()` 方法验证规则格式
    - 实现 `RuleParser.serialize()` 方法序列化规则
    - _需求: 1.4_
  - [x] 1.2 编写规则DSL解析属性测试
    - **属性3: 规则DSL解析往返一致性**
    - **验证需求: 1.4**
  - [x] 1.3 实现规则运行时引擎
    - 创建 `ai_engine/decision_engine/rule_runtime.py`
    - 实现条件评估逻辑（AND/OR组合）
    - 实现优先级排序机制
    - 实现冷却时间管理
    - _需求: 1.1, 1.6_
  - [x] 1.4 编写规则评估属性测试
    - **属性1: 决策引擎规则评估完整性**
    - **属性2: 阈值告警触发正确性**
    - **验证需求: 1.1, 1.2, 1.6**
  - [x] 1.5 实现动作执行器
    - 创建 `ai_engine/decision_engine/action_executor.py`
    - 实现告警动作处理
    - 实现通知动作处理（邮件、短信）
    - 实现Webhook动作处理
    - _需求: 1.3_
  - [x] 1.6 实现审计日志记录
    - 创建 `ai_engine/decision_engine/audit_logger.py`
    - 创建审计日志数据库表
    - 实现规则触发日志记录
    - _需求: 1.5_
  - [x] 1.7 编写审计日志属性测试
    - **属性4: 决策审计日志完整性**
    - **验证需求: 1.5**

- [x] 2. 检查点 - 决策引擎完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 3. 模型文件存储服务
  - [x] 3.1 实现存储后端抽象
    - 创建 `ai_engine/model_storage/storage_backend.py`
    - 定义 `StorageBackend` 抽象基类
    - 实现文件格式验证（.pkl, .onnx, .h5, .joblib）
    - 实现校验和计算
    - _需求: 2.2, 2.3_
  - [x] 3.2 编写文件格式验证属性测试
    - **属性6: 模型文件格式验证**
    - **验证需求: 2.2**
  - [x] 3.3 实现MinIO存储后端
    - 创建 `ai_engine/model_storage/minio_storage.py`
    - 实现文件上传、下载、删除功能
    - 实现文件存在性检查
    - _需求: 2.1_
  - [x] 3.4 实现本地文件存储后端
    - 创建 `ai_engine/model_storage/local_storage.py`
    - 实现本地文件系统存储
    - _需求: 2.1_
  - [x] 3.5 编写存储往返属性测试
    - **属性5: 模型文件存储往返一致性**
    - **验证需求: 2.1, 2.3**
  - [x] 3.6 集成模型存储到推理服务
    - 修改 `app/services/ai/inference_service.py`
    - 实现从存储后端加载模型
    - 实现模型版本激活时的文件加载
    - _需求: 2.4_
  - [x] 3.7 编写模型激活属性测试
    - **属性7: 模型版本激活后可用性**
    - **验证需求: 2.4**
  - [x] 3.8 实现模型文件清理
    - 实现删除模型版本时清理文件
    - _需求: 2.5_
  - [x] 3.9 编写文件清理属性测试
    - **属性8: 模型文件删除清理**
    - **验证需求: 2.5**
  - [x] 3.10 创建模型存储API端点
    - 创建 `app/api/v3/model_storage.py`
    - 实现上传、下载、删除端点
    - _需求: 2.6_

- [x] 4. 检查点 - 模型存储完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. WebSocket实时推送服务
  - [x] 5.1 实现WebSocket连接管理器
    - 创建 `platform/realtime/websocket_server.py`
    - 实现连接建立和断开处理
    - 实现用户认证验证
    - _需求: 3.1_
  - [x] 5.2 实现订阅管理
    - 创建 `platform/realtime/subscription_manager.py`
    - 实现资产订阅和取消订阅
    - 实现批量订阅支持
    - _需求: 3.3, 3.5_
  - [x] 5.3 编写订阅过滤属性测试
    - **属性9: WebSocket订阅数据过滤**
    - **验证需求: 3.3, 3.5**
  - [x] 5.4 实现实时推送服务
    - 创建 `platform/realtime/push_service.py`
    - 实现Redis发布订阅集成
    - 实现数据推送逻辑
    - _需求: 3.2_
  - [x] 5.5 实现推送消息格式
    - 确保消息包含时间戳和质量标识
    - 实现告警推送格式
    - _需求: 3.6_
  - [x] 5.6 编写消息格式属性测试
    - **属性10: 实时推送数据完整性**
    - **验证需求: 3.6**
  - [x] 5.7 创建WebSocket API端点
    - 在 `app/api/v3/__init__.py` 添加WebSocket路由
    - 实现JWT认证中间件
    - _需求: 3.1, 3.4_
  - [x] 5.8 实现前端WebSocket客户端
    - 创建 `web/src/utils/websocket.js`
    - 实现自动重连机制
    - 实现连接状态管理
    - _需求: 3.4, 7.1, 7.6_

- [x] 6. 检查点 - WebSocket推送完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 7. 预测结果时序存储
  - [x] 7.1 创建TDengine预测表结构
    - 创建 `migrations/platform_upgrade/003_create_prediction_tables.sql`
    - 定义 pred_{category} 超级表模板
    - _需求: 4.2_
  - [x] 7.2 编写表命名规范属性测试
    - **属性12: 预测表命名规范**
    - **验证需求: 4.2**
  - [x] 7.3 实现预测存储服务
    - 创建 `ai_engine/inference/prediction_store.py`
    - 实现PostgreSQL写入
    - 实现TDengine写入
    - _需求: 4.1_
  - [x] 7.4 编写双写一致性属性测试
    - **属性11: 预测结果双写一致性**
    - **验证需求: 4.1, 8.1**
  - [x] 7.5 实现预测查询服务
    - 实现按时间范围筛选
    - 实现按资产筛选
    - 实现按模型筛选
    - _需求: 4.3_
  - [x] 7.6 编写查询过滤属性测试
    - **属性13: 预测查询过滤正确性**
    - **验证需求: 4.3**
  - [x] 7.7 实现预测统计计算
    - 实现准确率计算
    - 实现偏差统计
    - 实现预测与实际值对比
    - _需求: 4.4, 4.5_
  - [x] 7.8 集成预测存储到推理服务
    - 修改 `app/services/ai/inference_service.py`
    - 在预测完成后调用存储服务
    - _需求: 4.1_

- [x] 8. 检查点 - 预测存储完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 9. 数据采集层实现
  - [x] 9.1 实现协议适配器基类
    - 创建 `platform/ingestion/adapters/base_adapter.py`
    - 定义适配器抽象接口
    - 实现统计信息收集
    - _需求: 5.1_
  - [x] 9.2 实现MQTT适配器
    - 创建 `platform/ingestion/adapters/mqtt_adapter.py`
    - 实现MQTT连接和消息接收
    - 实现消息解析
    - _需求: 5.1_
  - [x] 9.3 实现HTTP适配器
    - 创建 `platform/ingestion/adapters/http_adapter.py`
    - 实现HTTP轮询数据接收
    - _需求: 5.1_
  - [x] 9.4 实现数据验证器
    - 创建 `platform/ingestion/validator.py`
    - 实现类型验证
    - 实现范围验证
    - _需求: 5.2_
  - [x] 9.5 编写数据验证属性测试
    - **属性14: 数据采集验证有效性**
    - **验证需求: 5.2**
  - [x] 9.6 实现重试机制
    - 实现连接重试
    - 实现错误记录
    - _需求: 5.4_
  - [x] 9.7 实现采集状态监控
    - 创建状态监控接口
    - 实现统计信息API
    - _需求: 5.5_
  - [x] 9.8 创建数据源管理API
    - 创建 `app/api/v3/ingestion.py`
    - 实现数据源CRUD
    - 实现启动/停止控制
    - _需求: 5.1, 5.6_
  - [x] 9.9 创建数据源配置表
    - 创建 `migrations/platform_upgrade/004_create_ingestion_tables.sql`
    - _需求: 5.1_

- [x] 10. 检查点 - 数据采集层完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 11. 特征存储完善
  - [x] 11.1 实现特征表自动创建
    - 修改 `ai_engine/feature_hub/feature_store.py`
    - 实现 `create_feature_table()` 方法
    - _需求: 6.1_
  - [x] 11.2 编写特征表创建属性测试
    - **属性17: 特征表自动创建**
    - **验证需求: 6.1**
  - [x] 11.3 实现Schema演进
    - 实现 `evolve_schema()` 方法
    - 支持添加新特征列
    - _需求: 6.4_
  - [x] 11.4 实现特征血缘追踪
    - 创建 `ai_engine/feature_hub/lineage_tracker.py`
    - 实现血缘记录
    - 实现血缘查询
    - _需求: 6.5_
  - [x] 11.5 编写血缘追踪属性测试
    - **属性18: 特征血缘追踪完整性**
    - **验证需求: 6.5**
  - [x] 11.6 实现特征数据查询
    - 实现按资产筛选
    - 实现按时间范围筛选
    - 实现按特征名筛选
    - _需求: 6.3_
  - [x] 11.7 集成特征存储到流计算
    - 修改 `app/services/feature_engine.py`
    - 在激活特征视图时创建表
    - _需求: 6.1, 6.2_

- [x] 12. 检查点 - 特征存储完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 13. 双写模式集成
  - [x] 13.1 实现双写配置管理
    - 创建 `platform/ingestion/dual_write_config.py`
    - 实现全局和按类别配置
    - _需求: 8.5_
  - [x] 13.2 实现双写适配器
    - 创建 `platform/ingestion/dual_writer.py`
    - 实现新旧结构同时写入
    - 实现错误隔离
    - _需求: 8.1, 8.2_
  - [x] 13.3 编写错误隔离属性测试
    - **属性15: 双写错误隔离**
    - **验证需求: 8.2**
  - [x] 13.4 实现一致性验证
    - 实现新旧数据对比
    - 生成一致性报告
    - _需求: 8.3_
  - [x] 13.5 编写一致性报告属性测试
    - **属性16: 数据一致性报告准确性**
    - **验证需求: 8.3**
  - [x] 13.6 创建双写管理API
    - 在 `app/api/v3/ingestion.py` 添加双写端点
    - 实现配置查询和更新
    - 实现一致性验证触发
    - _需求: 8.4_
  - [x] 13.7 创建双写配置表
    - 添加到 `migrations/platform_upgrade/004_create_ingestion_tables.sql`
    - _需求: 8.5_

- [x] 14. 检查点 - 双写模式完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 15. 企业身份集成
  - [x] 15.1 实现身份提供商抽象
    - 创建 `app/services/auth/identity_provider.py`
    - 定义 `IdentityProvider` 基类
    - 定义 `UserInfo` 数据类
    - _需求: 10.1, 10.2_
  - [x] 15.2 实现LDAP提供商
    - 创建 `app/services/auth/ldap_provider.py`
    - 实现LDAP认证
    - 实现用户信息获取
    - _需求: 10.1_
  - [x] 15.3 编写LDAP认证属性测试
    - **属性20: LDAP认证有效性**
    - **验证需求: 10.1**
  - [x] 15.4 实现OAuth2提供商
    - 创建 `app/services/auth/oauth2_provider.py`
    - 实现授权码流程
    - 实现用户信息获取
    - _需求: 10.2_
  - [x] 15.5 实现身份管理服务
    - 创建 `app/services/auth/identity_manager.py`
    - 实现多提供商管理
    - 实现本地用户自动创建
    - _需求: 10.3, 10.5_
  - [x] 15.6 编写用户自动创建属性测试
    - **属性21: 外部用户自动创建**
    - **验证需求: 10.3**
  - [x] 15.7 实现角色同步
    - 实现组到角色映射
    - 实现角色自动同步
    - _需求: 10.4_
  - [x] 15.8 编写角色同步属性测试
    - **属性22: 角色同步正确性**
    - **验证需求: 10.4**
  - [x] 15.9 创建身份集成API
    - 创建 `app/api/v3/identity.py`
    - 实现提供商管理端点
    - 实现外部认证端点
    - _需求: 10.1, 10.2_
  - [x] 15.10 创建身份集成数据库表
    - 创建 `migrations/platform_upgrade/005_create_identity_tables.sql`
    - _需求: 10.5_

- [x] 16. 检查点 - 身份集成完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 17. 前端实时监控增强
  - [x] 17.1 创建WebSocket客户端组件
    - 创建 `web/src/utils/websocket.js`
    - 实现连接管理
    - 实现自动重连
    - _需求: 7.1, 7.6_
  - [x] 17.2 创建实时图表组件
    - 创建 `web/src/components/realtime/RealtimeChart.vue`
    - 实现数据实时更新
    - _需求: 7.2_
  - [x] 17.3 创建告警通知组件
    - 创建 `web/src/components/realtime/AlertNotification.vue`
    - 实现告警实时显示
    - _需求: 7.4_
  - [x] 17.4 创建预测结果显示组件
    - 创建 `web/src/components/realtime/PredictionDisplay.vue`
    - 显示预测值和置信度
    - _需求: 7.3_
  - [x] 17.5 创建连接状态指示器
    - 创建 `web/src/components/realtime/ConnectionStatus.vue`
    - 显示WebSocket连接状态
    - _需求: 7.6_
  - [x] 17.6 集成到监控页面
    - 修改 `web/src/views/assets/monitor/index.vue`
    - 集成WebSocket客户端
    - 集成实时组件
    - _需求: 7.1, 7.2, 7.3, 7.4_
  - [x] 17.7 实现刷新频率配置
    - 添加用户配置选项
    - _需求: 7.5_

- [x] 18. 检查点 - 前端实时监控完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 19. 目录结构重构
  - [x] 19.1 创建platform目录结构
    - 创建 `platform/` 目录
    - 创建 `platform/metadata/` 子目录
    - 创建 `platform/timeseries/` 子目录
    - 创建 `platform/ingestion/` 子目录
    - _需求: 9.2, 9.3, 9.4_
  - [x] 19.2 迁移元数据相关代码
    - 迁移资产类别相关代码到 `platform/metadata/`
    - 迁移信号定义相关代码
    - _需求: 9.2_
  - [x] 19.3 迁移时序数据相关代码
    - 迁移TDengine相关代码到 `platform/timeseries/`
    - _需求: 9.3_
  - [x] 19.4 创建ai_engine目录结构
    - 确保 `ai_engine/` 目录结构完整
    - 包含 feature_hub, model_registry, inference, decision_engine
    - _需求: 9.1_
  - [x] 19.5 更新导入路径
    - 更新所有受影响文件的导入语句
    - 确保向后兼容
    - _需求: 9.5_
  - [x] 19.6 编写API兼容性属性测试
    - **属性19: API兼容性保持**
    - **验证需求: 9.5**
  - [x] 19.7 更新模块依赖文档
    - 创建模块依赖关系图
    - 更新README文档
    - _需求: 9.6_

- [x] 20. 检查点 - 目录重构完成
  - 确保所有测试通过，如有问题请询问用户

- [x] 21. 决策引擎API和前端
  - [x] 21.1 创建决策规则API
    - 创建 `app/api/v3/decision.py`
    - 实现规则CRUD端点
    - 实现启用/禁用端点
    - _需求: 1.4, 1.6_
  - [x] 21.2 创建审计日志API
    - 添加审计日志查询端点
    - _需求: 1.5_
  - [x] 21.3 创建决策规则前端页面
    - 创建 `web/src/views/ai-engine/rules/index.vue`
    - 实现规则列表和管理
    - _需求: 1.4, 1.6_
  - [x] 21.4 创建规则编辑器组件
    - 创建可视化规则编辑器
    - 支持条件和动作配置
    - _需求: 1.4_
  - [x] 21.5 创建审计日志前端页面
    - 创建 `web/src/views/ai-engine/audit/index.vue`
    - 显示规则触发历史
    - _需求: 1.5_

- [x] 22. 集成测试和部署准备
  - [x] 22.1 创建集成测试套件
    - 创建 `tests/test_v2_integration.py`
    - 测试决策引擎完整流程
    - 测试实时推送完整流程
    - 测试双写完整流程
  - [x] 22.2 创建数据库迁移脚本
    - 整合所有迁移脚本
    - 创建回滚脚本
  - [x] 22.3 更新部署配置
    - 更新Docker配置
    - 更新环境变量配置
    - 添加MinIO配置
  - [x] 22.4 创建部署文档
    - 创建V2升级部署指南
    - 记录配置要求
    - 记录迁移步骤

- [x] 23. 最终检查点 - V2升级完成
  - 确保所有测试通过
  - 确保所有文档更新
  - 如有问题请询问用户

## 注意事项

- 所有任务都是必需的，包括属性测试任务
- 每个任务都引用了具体的需求以便追溯
- 检查点任务用于确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
